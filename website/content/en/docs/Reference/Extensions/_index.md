
---
title: "Extensions"
linkTitle: "Extensions"
weight: 6
date: 2017-01-05
description: >
  Tutorial on how to use the extensions
---

# Alf.io extensions

The official repository for the extensions can be found [here](https://github.com/alfio-event/alf.io-extensions).

# How to write an extension

Extensions allows you to link Alf.io with your existing tools, such as:

* Billing/Accounting systems
* CRMs
* Additional Email marketing services (Mailjet, ...)
* Custom notifications (Slack, Telegram, etc.)

## How it works

Extensions can be added and modified only by the Administrator. 
For security and stability reasons, it is not possible to do that with less privileged users.

Each extension consists of a JavaScript script. You can find a sample below:

```javascript
/**
 * The script metadata object describes whether or not your extension should be invoked asynchronously, and which events it supports
 * @returns {{ async: boolean, events: string[] }}
 */
function getScriptMetadata() {
    return {
        id: 'myExtensionIdentifier', // optional: id and version will be used later as a mechanism for checking if the script has a newer version
        displayName: 'My Extension', //mandatory: the name displayed in the configuration page
        version: 0, // optional
        async: false,
        events: [
            //supported values:
            //'RESERVATION_CONFIRMED', //fired on reservation confirmation. No results expected.
            //'RESERVATION_EXPIRED', //fired when reservation(s) expired
            //'RESERVATION_CANCELLED', //fired when reservation(s) are cancelled
            //'TICKET_CANCELLED', //fired when ticket(s) (but not the entire reservation) are cancelled
            //'TICKET_ASSIGNED', //fired on ticket assignment. No results expected.
            //'TICKET_CHECKED_IN', //fired when a ticket has been checked in. No results expected.
            //'TICKET_REVERT_CHECKED_IN', //fired when a ticket has been reverted from the checked in status. No results expected.
            //'WAITING_QUEUE_SUBSCRIPTION', //fired on waiting queue subscription. No results expected.
            //'STUCK_RESERVATIONS', //fired when the system has detected stuck reservations. No results expected.
            //'OFFLINE_RESERVATIONS_WILL_EXPIRE', //fired when an offline reservation will expire. No results expected.
            //'EVENT_CREATED', //fired when an event has been created. Return boolean for synchronous variant, no results expected for the asynchronous one.
            //'EVENT_STATUS_CHANGE', //fired when an event status has changed (normally, from DRAFT to PUBLIC). Return boolean for synchronous variant, no results expected for the asynchronous one.
            'INVOICE_GENERATION' //, //fired on invoice generation. Returns the invoice model.
            //'TAX_ID_NUMBER_VALIDATION' //fired in case a TAX ID (VAT/GST) Number has to be formally validated
        ]
        //,
        //parameters: {fields: [{name:'name',description:'description',type:'TEXT',required:true}], configurationLevels: ['SYSTEM', 'ORGANIZATION', 'EVENT']} //parameters
    };
}

/**
 * Executes the extension.
 * @param scriptEvent
 * @returns Object
 */
function executeScript(scriptEvent) {
    log.warn('hello from script with event: ' + scriptEvent);
    log.warn('extension parameters are: ' + extensionParameters);
    //this sample calls the https://csrng.net/ website and generates a random invoice number
    var randomNumber = simpleHttpClient.get('https://csrng.net/csrng/csrng.php?min=0&max=100').getJsonBody()[0].random;
    log.warn('the invoice number will be: ' + randomNumber);
    return {
        invoiceNumber: randomNumber
    };
}
```

Each extension is registered to one or more Application Events, and is fired as soon as the Application Event occurs.

## Scope Variables

Alf.io provides some objects and properties to the script in the script scope:

|        Variable       |                                                             Type                                                            |                                                                                                 Explanation                                                                                                |
|---------------------  |-----------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|         `log`         |                                                           `Log4j`                                                           |                                                                                                  A logger                                                                                                  |
|   `extensionLogger`   |                                                      `ExtentionLogger`                                                      | A logger that writes in the extension_log table. It implements the [`ExtensionLogger`] ( https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/extension/ExtensionLogger.java) interface.  |
|      `httpClient`     |                                     [`OkHttpClient`] ( http://square.github.io/okhttp/)                                     |                                                                                                                                                                                                            |
|   `simpleHttpClient`  | [`SimpleHttpClient`](https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/extension/SimpleHttpClient.java) |                                                                                                                                                                                                            |
|         `GSON`        |         [JSON parser/generator](http://static.javadoc.io/com.google.code.gson/gson/2.8.2/com/google/gson/Gson.html)         |                                                                                                                                                                                                            |
|     `returnClass`     |                                                     `java.lang.Class<?>`                                                    |                                                                                                                                                                                                            |
| `extensionParameters` |                                                    `Map<String, Object>`                                                    |                                                                                                                                                                                                            |
|        `event`        |             [`Event`]( https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/model/Event.java)             |                                                                                                                                                                                                            |
|       `eventId`       |                                                            `int`                                                            |                                                                                                                                                                                                            |
|    `organizationId`   |                                                            `int`                                                            |                                                                                                                                                                                                            |
|        `Utils`        |  [`ExtensionUtils`]( https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/extension/ExtensionUtils.java)  |                                                                                                                                                                                                            |
  

Other event-related variables are also injected in the scope.

## Supported Application Events
| Event                            | Additional global variables                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Expected result type                                                                                                                          | About                                                                                                                                                                                                                                                                                                                                                                 |
|----------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| RESERVATION_CONFIRMED            | `TicketReservation reservation`<br>`BillingDetails billingDetails`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `void`                                                                                                                                        | Extensions will be invoked **asynchronously** once a reservation has been confirmed.                                                                                                                                                                                                                                                                                  |
| RESERVATION_CANCELLED            | `Collection<String> reservationIdsToRemove`<br>`Event event`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `void`                                                                                                                                        | Extensions will be invoked **synchronously** once one or more reservations have expired.                                                                                                                                                                                                                                                                              |
| RESERVATION_CREDIT_NOTE_ISSUED   | `Event event`<br>`List<String> reservationIds`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `void`                                                                                                                                        | Extensions will be invoked **synchronously** when the reservations credit note is issued for the event.                                                                                                                                                                                                                                                               |
| TICKET_CANCELLED                 | `Collection<String> ticketUUIDs`<br>`Event event`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `void`                                                                                                                                        | Extension will be invoked **synchronously** once one or more tickets (but not the entire reservation at once) have been cancelled. Once a ticket has been cancelled, its UUID is reset.                                                                                                                                                                               |
| RESERVATION_EXPIRED              | `Collection<String> reservationIdsToRemove`<br>`Event event`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `void`                                                                                                                                        | Extensions will be invoked **synchronously** once one or more reservations have expired.                                                                                                                                                                                                                                                                              |
| TICKET_ASSIGNED                  | `Ticket ticket`<br>`Map<String, List<String>> additionalInfo`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `void`                                                                                                                                        | Extensions will be invoked **asynchronously** once a ticket has been assigned.                                                                                                                                                                                                                                                                                        |
| WAITING_QUEUE_SUBSCRIBED         | `WaitingQueueSubscription waitingQueueSubscription`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `void`                                                                                                                                        | Extensions will be invoked **asynchronously** once someone subscribes to the waiting queue.                                                                                                                                                                                                                                                                           |
| INVOICE_GENERATION               | `String reservationId`<br>`String email`<br>`String customerName`<br>`String userLanguage`: ISO 639-1 2-letters language code<br>`String billingAddress`<br>`String customerReference`<br>[`TotalPrice`](https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/model/TotalPrice.java) `reservationCost`<br>`boolean invoiceRequested`: whether or not the user has requested an invoice or just a receipt<br>`String vatCountryCode`: the EU country of business of the customer, if any<br>`String vatNr`<br>[`VatStatus`](https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/model/PriceContainer.java#L37) `vatStatus`: see [#278](https://github.com/alfio-event/alf.io/issues/278) | `Optional<`[`InvoiceGeneration`](https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/model/extension/InvoiceGeneration.java)`>` | Extensions will be invoked **synchronously** while generating an invoice.                                                                                                                                                                                                                                                                                             |
| TAX_ID_NUMBER_VALIDATION         | `String countryCode`<br>`String taxIdNumber`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `boolean`                                                                                                                                     | Extensions will be invoked **synchronously** when a Tax ID (VAT/GST) number has to be validated. Please note that Alf.io already supports EU VAT validation (by calling the EU VIES web service). In these cases, the TAX_ID validation will be called only as fallback. **Your extension should return a failed validation result if the country is not supported.** |
| RESERVATION_VALIDATION           | `Event event`<br>`String reservationId`<br>`TicketReservation reservation`<br>`Object clientForm`<br>`NamedParameterJdbcTemplate jdbcTemplate`<br>`BindingResult bindingResult`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `void`                                                                                                                                        | Extensions will be invoked **synchronously** when a reservation needs to be validated.                                                                                                                                                                                                                                                                                |
| EVENT_METADATA_UPDATE            | [`AlfioMetadata`](https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/model/metadata/AlfioMetadata.java) `metadata`<br>`Event event`<br>`Organization organization`<br>`MaybeConfiguration baseUrl`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | [`AlfioMetadata`](https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/model/metadata/AlfioMetadata.java) `metadata`          | Extensions will be invoked **synchronously** when metadata needs to be updated.                                                                                                                                                                                                                                                                                       |
| STUCK_RESERVATIONS               | `List<String> stuckReservationsId`<br>`Event event`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `void`                                                                                                                                        | Extensions will be invoked **asynchronously** when the system detects a stuck reservation.                                                                                                                                                                                                                                                                            |
| OFFLINE_RESERVATIONS_WILL_EXPIRE | `List<TicketReservationInfo> reservations`<br>`Event event`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `void`                                                                                                                                        | Extensions will be invoked **asynchronously** when an offline reservation will expire.                                                                                                                                                                                                                                                                                |
| EVENT_CREATED                    | `Event event`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `void`                                                                                                                                        | Extensions will be invoked **asynchronously** and **synchronously** when an event has been created.                                                                                                                                                                                                                                                                   |
| EVENT_STATUS_CHANGE              | `Event.Status status`: possible values are 'DRAFT', 'PUBLIC' and 'DISABLED'<br>`Event event`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `void`                                                                                                                                        | Extensions will be invoked **asynchronously** and **synchronously** when an event status changes.                                                                                                                                                                                                                                                                     |
| TICKET_CHECKED_IN                | `Ticket ticket`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `void`                                                                                                                                        | Extensions will be invoked **asynchronously** once a ticket has been checked in.                                                                                                                                                                                                                                                                                      |
| TICKET_REVERT_CHECKED_IN         | `Ticket ticket`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `void`                                                                                                                                        | Extensions will be invoked **asynchronously** once a ticket has been reverted from the checked in status.                                                                                                                                                                                                                                                             |
| PDF_GENERATION                   | `String html`<br>`Event event`<br>`OutputStream outputStream`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `boolean`                                                                                                                                     | Extensions will be invoked **synchronously** when there is a PDF transformation. A `boolean` is returned to indicate if it was successful or not.                                                                                                                                                                                                                     |
| OAUTH2_STATE_GENERATION          | `int organizationId`<br>`MaybeConfiguration baseUrl`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `Optional<String>`                                                                                                                            | Extensions will be invoked when an OAuth needs to be generated to a state parameter.                                                                                                                                                                                                                                                                                  |
| CONFIRMATION_MAIL_CUSTOM_TEXT    | `Event event`<br>`TicketReservation reservation`<br>`TicketReservationAdditionalInfo additionalInfo`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `Optional<`[`CustomEmailText`](https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/model/extension/CustomEmailText.java)`>` | Extensions will be invoked  **synchronously** when a reservation email custom text is made.                                                                                                                                                                                                                                                                           |
| TICKET_MAIL_CUSTOM_TEXT          | `Event event`<br>`TicketReservation reservation`<br>`TicketReservationAdditionalInfo additionalInfo`<br>`List<TicketFieldValue> fields`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `Optional<`[`CustomEmailText`](https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/model/extension/CustomEmailText.java)`>`                                                                                                                  | Extensions will be invoked **synchronously** when a ticket email custom text is made.                                                                                                                                                                                                                                                                                 |
| REFUND_ISSUED                    | `Event event`<br>`TicketReservation reservation`<br>`TransactionAndPaymentInfo info`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `void`                                                                                                                                        | Extensions will be invoked **asynchronously** once a refund needs to be made.                                                                                                                                                                                                                                                                                         |
| DYNAMIC_DISCOUNT_APPLICATION     | `Event event`<br>`Map<Integer, Long> quantityByCategory`<br>`String reservationId`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `Optional<`[`PromoCodeDiscount`](https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/model/PromoCodeDiscount.java)`>`       | Extensions will be invoked **synchronously** when a discount needs to be applied.                                                                                                                                                                                                                                                                                     |
| ONLINE_CHECK_IN_REDIRECT         | `String originalUrl`<br>`Ticket ticket`<br>[`EventWithCheckInInfo`](https://github.com/alfio-event/alf.io/blob/master/src/main/java/alfio/model/checkin/EventWithCheckInInfo.java) `event`<br>`int eventId`<br>`int organizationId`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `Optional<String>`                                                                                                                            | Extensions will be invoked when an online check in happens.                                                                                                                                                                                                                                                                                                           |
## Methods

#### getScriptMetadata

This methods returns the actual configuration options and capabilities of the extension.
It **must** return a JSON object with the following properties:

* async *boolean*: whether or not the script should be invoked asynchronously.
* events *string[]*: list of supported events
* configuration *{(key: string): string}*: the extension configuration (WIP)

#### executeScript

The actual event handling. Return types are event-dependent. Will always receive a single parameter (scriptEvent) 
which is the event that triggered the script.